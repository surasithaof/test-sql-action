# .github/workflows/publish-migrations.yml
name: Publish DB migrations to deployment repo

on:
  pull_request:
    branches: [master]
    # types: [closed]
    types: [opened, reopened, synchronize, ready_for_review]
    paths:
      - "migrations/**.sql" # adjust to your service repo path
      - ".github/workflows/publish-migrations.yml" # to allow workflow updates

jobs:
  open-deployment-pr:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      # Needed by peter-evans/create-pull-request for the target repo
      pull-requests: write

    env:
      DEPLOYMENT_REPO: surasithaof/test-deployments
      TARGET_DIR: overlay/dev/bytebase # adjust to whatever Bytebase watches
      SERVICE_MIGRATIONS_DIR: migrations # path in the service repo
      GIT_AUTHOR_NAME: migration-bot
      GIT_AUTHOR_EMAIL: migration-bot@users.noreply.github.com

    steps:
      - name: Check out service repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find newly added SQL files in this push
        id: changed
        run: |
          # Find added or modified files limited to *.sql under SERVICE_MIGRATIONS_DIR
          # git diff --name-status ${{ github.event.before }} ${{ github.sha }} \
          git diff --name-status origin/master HEAD \
            | awk '$1=="A" || $1=="M"{print $2}' \
            | grep -E '^'"${SERVICE_MIGRATIONS_DIR}"'/.*\.sql$' || true > "$RUNNER_TEMP/changed_files.txt"

          echo "Changed files:"
          echo $(cat "$RUNNER_TEMP/changed_files.txt")

          count=$(wc -l < "$TMPLIST" | xargs)
          echo "count=$count" >> $GITHUB_OUTPUT

      - name: Stop if nothing new
        if: steps.changed.outputs.count == '0'
        run: echo "No new migrations. Skipping."

      - name: Clone deployment repo
        if: steps.changed.outputs.count != '0'
        run: |
          git clone "https://x-access-token:${{ secrets.DEPLOYMENT_REPO_TOKEN }}@github.com/${{ env.DEPLOYMENT_REPO }}.git" /tmp/deployment
          cd /tmp/deployment
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"

      - name: Prepare branch and copy files
        if: steps.changed.outputs.count != '0'
        env:
          LIST_FILE: ${{ steps.changed.outputs.list }}
        run: |
          BRANCH="migrations/${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ github.run_id }}"
          cd /tmp/deployment
          git checkout -b "$BRANCH"

          mkdir -p "${TARGET_DIR}"

          # git diff --name-status ${{ github.event.before }} ${{ github.sha }} \
          git diff --name-status origin/master HEAD \
            | awk '$1=="A" || $1=="M"{print $2}' \
            | grep -E '^'"${SERVICE_MIGRATIONS_DIR}"'/.*\.sql$' || true > "$RUNNER_TEMP/changed_files.txt"

          while IFS= read -r f; do
            cp "${GITHUB_WORKSPACE}/$f" "/tmp/deployment/${TARGET_DIR}/$(basename "$f")"
          done < "$RUNNER_TEMP/changed_files.txt"

          echo "Files now at ${TARGET_DIR}:"
          ls -la "${TARGET_DIR}"

      # - name: Create PR to deployment repo
      #   if: steps.changed.outputs.count != '0'
      #   uses: peter-evans/create-pull-request@v6
      #   with:
      #     token: ${{ secrets.DEPLOYMENT_REPO_TOKEN }}
      #     commit-message: "chore(db): publish migrations from ${{ github.event.repository.name }} (#${{ github.run_number }})"
      #     title: "DB migrations from `${{ github.event.repository.name }}`"
      #     body: |
      #       This PR publishes new DB migrations from `${{ github.event.repository.name }}`.
      #       - Source commit: ${{ github.sha }}
      #       - Target path: `${{ env.TARGET_DIR }}`
      #       When merged, Bytebase will pick these up and create a reviewable Change/Issue for SRE.
      #     branch: ${{ github.ref_name }}
      #     base: master
      #     author: "${{ env.GIT_AUTHOR_NAME }} <${{ env.GIT_AUTHOR_EMAIL }}>"
      #     committer: "${{ env.GIT_AUTHOR_NAME }} <${{ env.GIT_AUTHOR_EMAIL }}>"
      #     add-paths: |
      #       ${{ env.TARGET_DIR }}/**
      #     signoff: false\

      - name: Push changes to deployment repo
        if: steps.changed.outputs.count != '0'
        run: |
          cd /tmp/deployment
          git add "${TARGET_DIR}/"
          git commit -m "chore(db): publish migrations from ${{ github.event.repository.name }} (#${{ github.run_number }})"
          git push origin HEAD

      - name: Create PR to deployment repo
        if: steps.changed.outputs.count != '0'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.DEPLOYMENT_REPO_TOKEN }}
          commit-message: "chore(db): publish migrations from ${{ github.event.repository.name }} (#${{ github.run_number }})"
          title: "DB migrations from `${{ github.event.repository.name }}`"
          body: |
            This PR publishes new DB migrations from `${{ github.event.repository.name }}`.
            - Source commit: ${{ github.sha }}
            - Target path: `${{ env.TARGET_DIR }}`
            When merged, Bytebase will pick these up and create a reviewable Change/Issue for SRE.
          branch: "migrations/${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ github.run_id }}"
          base: master
